<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biblos – Logowanie</title>
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="theme-color" content="#2980b9">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Cropper.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

    <style>
        :root {
            --accent: #3498db;
            --accent2: #d35400;
            --bg-dark: rgba(0,0,0,0.4);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: url('background.png') no-repeat center center fixed;
            background-size: cover;
            color: white;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            max-width: 500px;
            width: 100%;
            background: var(--bg-dark);
            backdrop-filter: blur(15px);
            border-radius: 30px;
            box-shadow: 0 25px 70px rgba(0,0,0,0.7);
            padding: 60px 40px;
            text-align: center;
        }
        h1 {
            font-size: 4.5rem;
            letter-spacing: 8px;
            margin-bottom: 20px;
            text-transform: uppercase;
        }
        .subtitle {
            font-size: 1.6rem;
            margin-bottom: 50px;
            opacity: 0.9;
        }

        #newUserScreen { display: block; }
        #existingUserScreen { display: none; }

        input[type="text"] {
            width: 100%;
            padding: 18px 24px;
            font-size: 1.6rem;
            border: none;
            border-radius: 20px;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.15);
            color: white;
            text-align: center;
        }
        input[type="text"]::placeholder { color: rgba(255,255,255,0.7); }
        input[type="text"]:focus { outline: none; background: rgba(255,255,255,0.25); }

        button {
            padding: 16px 40px;
            font-size: 1.5rem;
            font-weight: bold;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: 0.4s;
            margin: 12px 0;
            width: 100%;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: #2980b9; transform: translateY(-6px); box-shadow: 0 15px 30px rgba(0,0,0,0.5); }
        .btn-secondary { background: rgba(255,255,255,0.15); color: white; border: 2px solid rgba(255,255,255,0.3); }
        .btn-secondary:hover { background: rgba(255,255,255,0.25); transform: translateY(-6px); }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }

        /* Awatar */
        .avatar-container {
            position: relative;
            width: 140px;
            height: 140px;
            margin: 0 auto 30px;
            display: inline-block;
        }
        .avatar {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            transition: 0.3s;
        }
        .avatar-default {
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5rem;
            font-weight: bold;
        }

        .change-avatar-btn {
            position: absolute;
            bottom: 8px;
            right: 8px;
            width: 36px;
            height: 36px;
            background: rgba(0,0,0,0.5);
            border: none;
            border-radius: 50%;
            font-size: 1.4rem;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
            transition: 0.3s;
        }
        .change-avatar-btn:hover {
            opacity: 1;
            background: rgba(0,0,0,0.7);
            transform: scale(1.1);
        }

        .user-name {
            font-size: 2.2rem;
            margin-bottom: 40px;
        }

        /* Cropper modal */
        #cropperModal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            flex-direction: column;
        }
        .cropper-container {
            width: 90vw;
            max-width: 500px;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
        }
        #cropImage {
            display: block;
            max-width: 100%;
        }
        .cropper-buttons {
            padding: 20px;
            background: #f8f8f8;
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        .cropper-buttons button {
            width: auto;
            padding: 12px 30px;
            margin: 0;
        }

        #avatarInput { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>BIBLOS</h1>
    <div class="subtitle">Języki biblijne</div>

    <div id="newUserScreen">
        <p style="font-size:1.4rem; margin-bottom:30px;">
            Podaj swoje imię, aby rozpocząć naukę
        </p>
        <input type="text" id="nameInput" placeholder="Wpisz swoje imię..." autofocus>
        <button class="btn-primary" id="saveNameBtn">Rozpocznij naukę</button>
    </div>

    <div id="existingUserScreen">
        <div class="avatar-container">
            <div id="avatarDisplay" class="avatar avatar-default"></div>
            <button class="change-avatar-btn" id="changeAvatarBtn" title="Zmień awatar">✏️</button>
        </div>
        <div class="user-name" id="welcomeName"></div>

        <button class="btn-primary" id="continueBtn">Kontynuuj jako <span id="continueName"></span></button>
        <button class="btn-secondary" id="newProfileBtn">Utwórz nowy profil</button>
        <button class="btn-danger" id="resetAllBtn">Resetuj wszystko (usuń dane)</button>
    </div>

    <input type="file" id="avatarInput" accept="image/*">
</div>

<!-- Modal croppera -->
<div id="cropperModal">
    <div class="cropper-container">
        <img id="cropImage" src="" alt="Przytnij zdjęcie">
        <div class="cropper-buttons">
            <button class="btn-secondary" id="cancelCrop">Anuluj</button>
            <button class="btn-primary" id="saveCrop">Zapisz awatar</button>
        </div>
    </div>
</div>

<script>
    const USER_KEY = 'biblos_current_user';
    const AVATAR_KEY = 'biblos_user_avatar';

    const newUserScreen = document.getElementById('newUserScreen');
    const existingUserScreen = document.getElementById('existingUserScreen');
    const nameInput = document.getElementById('nameInput');
    const saveNameBtn = document.getElementById('saveNameBtn');

    const avatarDisplay = document.getElementById('avatarDisplay');
    const changeAvatarBtn = document.getElementById('changeAvatarBtn');
    const avatarInput = document.getElementById('avatarInput');

    const welcomeName = document.getElementById('welcomeName');
    const continueName = document.getElementById('continueName');
    const continueBtn = document.getElementById('continueBtn');
    const newProfileBtn = document.getElementById('newProfileBtn');
    const resetAllBtn = document.getElementById('resetAllBtn');

    // Cropper
    const cropperModal = document.getElementById('cropperModal');
    const cropImage = document.getElementById('cropImage');
    const cancelCrop = document.getElementById('cancelCrop');
    const saveCrop = document.getElementById('saveCrop');
    let cropper = null;

    function getFirstLetter(name) {
        return name.trim().charAt(0).toUpperCase();
    }

    function loadAvatar() {
        const savedAvatar = localStorage.getItem(AVATAR_KEY);
        const user = localStorage.getItem(USER_KEY) || '?';

        if (savedAvatar) {
            avatarDisplay.style.backgroundImage = `url(${savedAvatar})`;
            avatarDisplay.style.backgroundSize = 'cover';
            avatarDisplay.style.backgroundPosition = 'center';
            avatarDisplay.textContent = '';
            avatarDisplay.classList.remove('avatar-default');
        } else {
            avatarDisplay.style.backgroundImage = '';
            avatarDisplay.classList.add('avatar-default');
            avatarDisplay.textContent = getFirstLetter(user);
        }
    }

    function checkUser() {
        const savedUser = localStorage.getItem(USER_KEY);
        if (savedUser && savedUser.trim() !== '') {
            newUserScreen.style.display = 'none';
            existingUserScreen.style.display = 'block';
            welcomeName.textContent = `Witaj ponownie, ${savedUser}!`;
            continueName.textContent = savedUser;
            loadAvatar();
        } else {
            newUserScreen.style.display = 'block';
            existingUserScreen.style.display = 'none';
            nameInput.focus();
        }
    }

    function goToApp() {
        window.location.href = 'app.html';
    }

    saveNameBtn.onclick = () => {
        let name = nameInput.value.trim();
        if (name === '') { alert('Proszę podać imię!'); return; }
        name = name.charAt(0).toUpperCase() + name.slice(1).toLowerCase();
        localStorage.setItem(USER_KEY, name);
        goToApp();
    };
    nameInput.addEventListener('keypress', e => { if (e.key === 'Enter') saveNameBtn.click(); });

    continueBtn.onclick = () => goToApp();

    newProfileBtn.onclick = () => {
        if (confirm('Czy na pewno chcesz utworzyć nowy profil? Obecny zostanie wylogowany.')) {
            localStorage.removeItem(USER_KEY);
            localStorage.removeItem(AVATAR_KEY);
            checkUser();
            nameInput.value = '';
            nameInput.focus();
        }
    };

    resetAllBtn.onclick = () => {
        if (confirm('UWAGA! To nieodwracalnie usunie WSZYSTKIE dane aplikacji.\nKontynuować?')) {
            if (confirm('Ostatnie ostrzeżenie. Na pewno?')) {
                localStorage.clear();
                alert('Wszystkie dane zostały usunięte.');
                checkUser();
            }
        }
    };

    // Zmiana awatara
    changeAvatarBtn.onclick = () => avatarInput.click();

    avatarInput.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        if (!file.type.startsWith('image/')) {
            alert('Proszę wybrać plik obrazu.');
            avatarInput.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = (ev) => {
            cropImage.src = ev.target.result;
            cropperModal.style.display = 'flex';

            // Zniszcz poprzedni cropper, jeśli istnieje
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }

            // Inicjalizuj nowy
            cropper = new Cropper(cropImage, {
                aspectRatio: 1 / 1,
                viewMode: 1,
                autoCropArea: 1,
                responsive: true,
                center: true,
                background: false,
                modal: true,
                guides: true,
                highlight: false,
                cropBoxMovable: true,
                cropBoxResizable: true
            });
        };
        reader.readAsDataURL(file);
    };

    // Anuluj przycinanie
    cancelCrop.onclick = () => {
        cropperModal.style.display = 'none';
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
        avatarInput.value = '';
    };

    // Zapisz przycięty awatar
    saveCrop.onclick = () => {
        if (!cropper) {
            cancelCrop.click();
            return;
        }

        const canvas = cropper.getCroppedCanvas({
            width: 300,
            height: 300,
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high'
        });

        const base64 = canvas.toDataURL('image/jpeg', 0.92);
        localStorage.setItem(AVATAR_KEY, base64);
        loadAvatar();

        // Zamknij modal i wyczyść
        cropperModal.style.display = 'none';
        cropper.destroy();
        cropper = null;
        avatarInput.value = '';
    };

    // Zamknij modal klikając poza obszar (opcjonalnie)
    cropperModal.onclick = (e) => {
        if (e.target === cropperModal) {
            cancelCrop.click();
        }
    };

    // Start
    checkUser();
</script>

</body>
</html>
